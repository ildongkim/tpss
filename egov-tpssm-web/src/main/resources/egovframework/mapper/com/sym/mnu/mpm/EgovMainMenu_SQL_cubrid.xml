<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="menuManageDAO">
	
    <resultMap id="selectMenuTreeMap" type="egovframework.com.sym.mnu.mpm.service.MenuManageVO">
        <result property="menuNo" column="MENU_NO"/>
		<result property="menuOrdr" column="MENU_ORDR"/>
		<result property="menuNm" column="MENU_NM"/>
		<result property="upperMenuId" column="UPPER_MENU_ID"/>
		<result property="authorCode" column="AUTHOR_CODE"/>
		<result property="registerId" column="REGISTER_ID"/>
		<association property="_attributes" javaType="java.util.HashMap" column="{menuNo=MENU_NO, authorCode=AUTHOR_CODE}" select="selectMenuChecked"/>
    </resultMap>
    
	<select id="selectMenuChecked" resultType="java.util.HashMap">
		SELECT CASE WHEN COUNT(B.AUTHOR_CODE) > 0 THEN 'true' ELSE 'false' END AS "checked"
		  FROM COMTNMENUCREATDTLS B WHERE B.MENU_NO = #{menuNo} AND B.AUTHOR_CODE = #{authorCode} AND B.USE_AT = 'Y'
	</select>
	
	<select id="selectMenuTreeList" parameterType="egovframework.com.sym.mnu.mpm.service.MenuManageVO" resultMap="selectMenuTreeMap">
		 
			SELECT
			       A.MENU_NO
				 , A.MENU_ORDR
				 , A.MENU_NM
				 , case when A.MENU_NO = 0 then 9999999 else A.UPPER_MENU_NO end AS UPPER_MENU_ID
				 , #{authorCode} AS AUTHOR_CODE
				 , #{registerId} AS REGISTER_ID
			FROM   COMTNMENUINFO A
			WHERE  A.USE_AT = 'Y'
			<if test='menuNo != null and menuNo != ""'>
			AND    ( A.MENU_NO = #{menuNo} OR A.UPPER_MENU_NO = #{menuNo} )
			</if>
			ORDER BY A.MENU_ORDR
	</select>
	
	<select id="selectMainMenuLeft" parameterType="egovframework.com.sym.mnu.mpm.service.MenuManageVO" resultType="egovframework.com.sym.mnu.mpm.service.MenuManageVO">
		 
			SELECT
			       B.MENU_NO           AS "menuNo"
				 , B.MENU_ORDR         AS "menuOrdr"
				 , B.MENU_NM           AS "menuNm"
				 , B.UPPER_MENU_NO     AS "upperMenuId"
				 , B.RELATE_IMAGE_PATH AS "relateImagePath"
				 , B.RELATE_IMAGE_NM   AS "relateImageNm"
				 , (SELECT C.URL FROM COMTNPROGRMLIST C WHERE B.PROGRM_FILE_NM = C.PROGRM_FILE_NM) AS "linkUrl"	
			FROM   COMTNMENUCREATDTLS A, COMTNMENUINFO B
			WHERE  A.MENU_NO  = B.MENU_NO
			AND    A.USE_AT   = B.USE_AT
			AND    A.USE_AT   = 'Y'
			AND    B.MENU_NO  > 0
			AND    A.AUTHOR_CODE = (SELECT AUTHOR_CODE from COMTNEMPLYRSCRTYESTBS
	                                WHERE  SCRTY_DTRMN_TRGET_ID = #{tmpUniqId})
			ORDER BY B.MENU_ORDR
	</select>
	
    <insert id="insertMenuCreat">
			MERGE INTO COMTNMENUCREATDTLS A
			USING db_root ON A.MENU_NO = #{menuNo} AND A.AUTHOR_CODE = #{authorCode}
			WHEN MATCHED THEN
				UPDATE SET 
					USE_AT = 'Y',
					LAST_UPDT_PNTTM = SYSDATETIME, 
					LAST_UPDUSR_ID = #{registerId}
			WHEN NOT MATCHED THEN
		    	INSERT ( MENU_NO, AUTHOR_CODE, USE_AT, 
		    		FRST_REGIST_PNTTM, FRST_REGISTER_ID, LAST_UPDT_PNTTM, LAST_UPDUSR_ID)
				VALUES ( #{menuNo}, #{authorCode}, 'Y',
					SYSDATETIME, #{registerId}, SYSDATETIME, #{registerId})
    </insert>
    
    <update id="updateMenuCreat">
        
		    UPDATE COMTNMENUCREATDTLS SET
			    USE_AT = 'N',
			    LAST_UPDT_PNTTM = SYSDATETIME, 
				LAST_UPDUSR_ID = #{registerId}
			WHERE AUTHOR_CODE = #{authorCode}
			  AND USE_AT = 'Y'
    </update>
    
</mapper>